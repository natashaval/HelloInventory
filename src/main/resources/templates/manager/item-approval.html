<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{fragments/layout}">
<head>
    <meta charset="UTF-8" />
    <title>Require Approval</title>
    <link rel="stylesheet" type="text/css" th:href="@{/plugin/DataTables/dataTables.min.css}" />
</head>
<body>
    <div layout:fragment="content" th:remove="tag">
        <div id="approval-result"></div>
        <table id="item-approval-table">
            <thead>
                <th>Request ID</th>
                <th>Request Time</th>
                <th>Requester ID</th>
                <th>Requester Name</th>
                <th>Actions</th>
            </thead>
        </table>

        <script type="text/javascript" th:src="@{/plugin/DataTables/dataTables.min.js}"></script>
        <script type="text/javascript" th:src="@{/plugin/MomentJs/moment.min.js}"></script>
        <script type="text/javascript" th:src="@{/js/bootbox.min.js}"></script>
        <script type="text/javascript">
            var approvalTable;
            $(document).ready(function(){
                approvalTable = $('#item-approval-table').DataTable({
                   ajax: '/manager/action/approval',
                   columns: [
                       {"data": "actionId"},
                       {
                           "data": "requestTime",
                           render: function (data, type, row){
                               // https://stackoverflow.com/questions/41514750/how-to-format-date-displayed-in-datatable
                               if (type === "sort" || type === "type") return data;
                               return moment(data).format("DD-MM-YYYY HH:mm");
                           }
                       },
                       {"data": "requestedBy.id"},
                       {"data": "requestedBy.name"},
                       {"data": null, "orderable": false}
                   ],
                    columnDefs: [
                        {
                            targets: -1,
                            data: null,
                            defaultContent:
                                "<button class='btn btn-warning approval-item'><span class='glyphicon glyphicon-info-sign'></span> Items</button>" +
                                " <button class='btn btn-success approval-accepted'><span class='glyphicon glyphicon-ok-circle'></span> Approve</button>" +
                                " <button class='btn btn-danger approval-rejected'><span class='glyphicon glyphicon-remove-circle'></span> Reject</button>"
                        }
                    ]
                });

                approvalButton();
            });

            function approvalButton(){
                $('#item-approval-table tbody').on('click', '.approval-item', function (e) {
                    approvalRow = approvalTable.row($(this).parents('tr')).data();
                    console.log(approvalRow.actionItemList);
                    actionId = approvalRow.actionId;

                    itemList = approvalRow.actionItemList;
                    var itemMessage = "<ol>";
                    // for (var i = 0; i < itemList.length; i++){
                    //     console.log(itemList[i].name);
                    // }
                    for (var i in approvalRow.actionItemList){
                        console.log(approvalRow.actionItemList[i].item.name);
                        // itemMessage += "<input type='text' class='form-control' readonly placeholder='" + approvalRow.actionItemList[i].item.name +
                        //         "' /><br />";
                        itemMessage += "<li>" + approvalRow.actionItemList[i].item.name + "</li><br />";
                    }
                    itemMessage += "</ol>";

                    bootbox.dialog({
                       title: "<span class='glyphicon glyphicon-info-sign'></span> Requested Items",
                       message: itemMessage,
                       buttons: {
                           ok: {
                               label: "Close",
                               className: "btn-secondary",
                               callback: function () {

                               }
                           }
                       }
                    });
                });

                $('#item-approval-table tbody').on('click', '.approval-accepted', function (e) {
                    approvalRow = approvalTable.row($(this).parents('tr')).data();
                    console.log(approvalRow);
                    actionId = approvalRow.actionId;

                    bootbox.dialog({
                       title: "<span class='glyphicon glyphicon-ok-circle'></span> Approve Request?",
                        message: "Are you sure to accept this request?",
                        backdrop: true,
                        buttons: {
                           cancel: {
                               label: "Cancel",
                               className: "btn-secondary",
                               callback: function(){
                                   $('.bootbox').modal('hide');
                               }
                           },
                            accept: {
                                label: "<span class='glyphicon glyphicon-ok-sign'></span> Approve",
                                className: "btn-success",
                                callback: function(){
                                    console.log("approve clicked");

                                    // AJAX approve request
                                    $.ajax({
                                       type: "POST",
                                       url: "/manager/action/" + actionId + "/approved",
                                       success: function(data){
                                           $('#item-approval-table').DataTable().ajax.reload();
                                           $('#approval-result').append("<p class='text-success'>"+ data.data +"</p>");
                                       },
                                        error: function(e){
                                            $('#approval-result').append("<p class='text-danger'>"+ data.data +"</p>");
                                        }
                                    });
                                }
                            }
                        }
                    });
                });

                $('#item-approval-table tbody').on('click', '.approval-rejected', function (e) {
                    approvalRow = approvalTable.row($(this).parents('tr')).data();
                    console.log(approvalRow);
                    actionId = approvalRow.actionId;

                    bootbox.dialog({
                        title: "<span class='glyphicon glyphicon-remove-circle'></span> Reject Request?",
                        message: "Are you sure to reject this request?",
                        buttons: {
                            success: {
                                label: "Cancel",
                                className: "btn-secondary",
                                callback: function(){
                                    $('.bootbox').modal('hide');
                                }
                            },
                            danger: {
                                label: "<span class='glyphicon glyphicon-remove-sign'></span> Reject",
                                className: "btn-danger",
                                callback: function(){
                                    console.log("reject clicked");

                                    // AJAX reject request
                                    $.ajax({
                                        type: "POST",
                                        url: "/manager/action/" + actionId + "/rejected",
                                        success: function(data){
                                            $('#item-approval-table').DataTable().ajax.reload();
                                            $('#approval-result').append("<p class='text-warning'>"+ data.data +"</p>");
                                        },
                                        error: function(e){
                                            $('#approval-result').append("<p class='text-danger'>"+ data.data +"</p>");
                                        }
                                    });
                                }
                            }
                        }
                    });
                });


                }
        </script>
    </div>
</body>
</html>